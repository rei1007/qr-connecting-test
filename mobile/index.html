<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマホ用ページ</title>
    <style>
        .card {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px auto;
            width: 300px;
            text-align: center;
            border-radius: 10px;
        }

        input {
            margin: 5px;
            padding: 5px;
        }

        label,button {
            display: block;
        }

        button {
            margin: 10px auto;
        }
    </style>
</head>

<body>
    <div class="card">
        <h3>PCとリンク</h3>
        <label for="instance_input">リンクコード:</label>
        <input type="text" autocapitalize="characters" id="instance_input" placeholder="リンクコード">
        <label for="password_input">リンクPIN:</label>
        <input type="text" id="password_input" placeholder="リンクPIN">
        <button onclick="connectWebSocket()">接続</button>
    </div>

    <div class="card">
        <h3>接続状態</h3>
        <p>PC: <span id="pc_status">未接続</span></p>
        <p>スマホ: <span id="phone_status">未接続</span></p>
    </div>

    <script>
        let ws; // WebSocketインスタンス
        let pcConnected = false;
        let phoneConnected = false;

        function connectWebSocket() {
            const instance = document.getElementById('instance_input').value.trim();
            const url = "wss://cloud.achex.ca/${instance}";
            const auth = "qct_auth";
            const password = document.getElementById('password_input').value.trim();

            window.addEventListener('load', function () {
                const hash = window.location.hash;
                const hashContent = hash.substring(1);
                const keyValuePairs = hashContent.split('&');

                keyValuePairs.forEach(pair => {
                    const [key, value] = pair.split('=');
                    const decodedValue = decodeURIComponent(value);

                    if (key === 'code') {
                        code = decodedValue;
                        document.getElementById('instance_input').value = code;
                    } else if (key === 'pass') {
                        pass = decodedValue;
                        document.getElementById('password_input').value = pass;
                    }
                });
            });

            if (!auth || !password) {
                alert("リンクコードとリンクPINを入力してください。");
                return;
            }

            ws = new WebSocket(url);

            ws.onopen = () => {
                console.log('WebSocket接続成功');
                document.getElementById('phone_status').innerText = "接続OK";
                document.getElementById('phone_status').style.color = "green";

                // 認証情報を送信
                const authData = JSON.stringify({ auth, password });
                ws.send(authData);

                // スマホ接続成功メッセージを送信
                const connectMessage = JSON.stringify({ to: auth, id: "connect_phone", contents: "success" });
                ws.send(connectMessage);
                console.log('送信: ID=connect_phone, Contents=success');
            };

            ws.onmessage = (event) => {
                console.log('受信:', event.data);
                try {
                    const data = JSON.parse(event.data);

                    // PCからのsuccessメッセージを受信した場合
                    if (data.id === "connect_pc" && data.contents === "success") {
                        pcConnected = true;
                        document.getElementById('pc_status').innerText = "接続OK";
                        document.getElementById('pc_status').style.color = "green";
                    }

                    // スマホからのsuccessメッセージを受信した場合（デバッグ用）
                    if (data.id === "connect_phone" && data.contents === "success") {
                        console.log("スマホからのsuccessを受信");
                    }
                } catch (e) {
                    console.error("受信データの解析エラー:", e);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket切断');
                document.getElementById('phone_status').innerText = "切断";
            };

            ws.onerror = (error) => {
                console.error('WebSocketエラー:', error);
                document.getElementById('phone_status').innerText = "エラー";
            };
        }
    </script>
</body>

</html>