<!DOCTYPE html>
<html>
<head>
    <title>PC Chat</title>
    <style>
        #chat {
            width: 100%;
            height: 300px;
            border: solid 1px #FFFFFF;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h1>PC Chat</h1>
    <div id="info">
        <p>インスタンス: qct</p>
        <p>認証: qctAuth</p>
        <p>パスワード: qctPass</p>
    </div>
    <div id="chat"></div>

    <script>
        var chat = document.getElementById("chat");
        // ID生成
        var id = Math.random().toString(32).substring(2);

        // WS接続（Achexへ接続）
        ws = new WebSocket("wss://cloud.achex.ca/chat");

        // WS接続
        ws.onopen = e => {
            console.log('open');
            chat.innerHTML = 'You ID : ' + id + '（' + getDateTime() + '）' + '<br>';
            // 認証
            ws.send(JSON.stringify({"auth": "qctAuth", "password": "qctPass", "instance": "qct"}));
            // Login
            ws.send(JSON.stringify({"to": "qct", "id": id, "message": 'Login'}));
        }

        // メッセージ受信
        ws.onmessage = e => {
            console.log('message');
            console.log(e);
            var obj = JSON.parse(e.data);
             if(obj.auth == 'OK'){
                // 認証OK
                return;
            }
            addChat(obj.id, obj.message);
        }

        // WS切断
        ws.onclose = e => {
            console.log('closed');
            ws.send(JSON.stringify({"to": "qct", "id": id, "message": 'Logout'}));
        }

         // チャット
        function addChat(id, msg) {
            chat.innerHTML = id + ' : ' + msg + '（' + getDateTime() + '）' + '<br>' + chat.innerHTML;
        }

        // 1桁の数字を0埋めで2桁にする
        var toDoubleDigits = function(num) {
            num += "";
            if (num.length === 1) {
                num = "0" + num;
            }
            return num;
        };

        // 日時取得 YYYY/MM/DD HH:DD:MI:SS形式で取得
        var getDateTime = function() {
            var date = new Date();
            var year = date.getFullYear();
            var month = toDoubleDigits(date.getMonth() + 1);
            var day = toDoubleDigits(date.getDate());
            var hour = toDoubleDigits(date.getHours());
            var min = toDoubleDigits(date.getMinutes());
            var sec = toDoubleDigits(date.getSeconds());
            return year + '/' + month + '/' + day + ' ' + hour + ':' + min + ':' + sec;
        };
    </script>
</body>
</html>
